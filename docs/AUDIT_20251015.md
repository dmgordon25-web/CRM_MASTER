# CRM Application Audit — 2025-10-15

## Executive Summary
- Boot flow is modular but tightly sequenced: loader → boot hardener → phased manifests. Core guards exist, yet a failed capability still relies on `console.error`, breaching the zero-error policy outside hard failures.
- Selection + action bar stack spans three adapters (`SelectionService`, `SelectionStore`, `Selection` adapter, plus DOM watchers). It keeps smoke selectors alive, but duplicate style injectors and legacy toggles complicate idempotence and risk stale state across route swaps.
- Partners UI wires filter/search, queue-based modal boot, and a new focus-trapped overlay. Singleton enforcement exists, but async re-entry and legacy dialog cloning can still create racey DOM swaps.
- Drag/drop subsystems (pipeline kanban, dashboard widgets) expose attach-once metrics, yet only kanban aggressively detaches on route exit; dashboard widgets persist listeners across mounts and could leak when host nodes churn.
- Calendar export path surfaces ICS + CSV buttons bound at runtime. ICS fallback works offline, while CSV emits plain UTF-8 without BOM and no timezone normalization—acceptable now but brittle for Excel/Outlook import expectations.
- Workbench now exposes saved queries backed by localStorage, mirrors global selection for bulk actions, and ships CSV export; action bar reuse remains limited but the view operates as a first-class console.
- Communications tooling still proxies to `mailto:` and unimplemented SMS adapters; gating hooks (`resolveEmailHandler`/`resolveSmsHandler`) fall back to toasts and never flag missing integrations.
- Console noise remains high: numerous modules call `console.error` for recoverable issues, defeating the “warn-only” policy and threatening smoke stability.
- Windows launcher scripts spin up the Node dev server headlessly and optionally WebView2 shell; no watchdog ensures the backend stays healthy or that ports remain unique across runs.

## Boot & Server
- **Loader + phases**: `crm-app/js/boot/loader.js` seeds `ensureCoreThenPatches`, guarded by `window.__BOOT_LOADER_MAIN__`. `manifest.js` lists core + patches; `boot/phase_runner.js` (via `boot_hardener.js`) enforces HARD/SOFT prereqs, flipping `window.__BOOT_DONE__` for smoke assertions.
- **Safe Mode**: `boot/phases.js` inspects `?safe=1` or `localStorage.SAFE` to trim feature modules.
- **Servers**:
  - `tools/dev_server.mjs`: headless Node server with SPA fallback to `index.html`, auto port scan (8087+), optional browser launch on Windows.
  - `tools/node_static_server.js`: simple static server for CI (smoke uses it). It maps `/`→`index.html`, provides `/health` and `/__log` POST (writes to OS-specific logs dir), but lacks hashed-route fallback beyond `index.html` resolution.
  - `.NET launcher` (`tools/server/Program.cs` + `Shell` WebView2 front-end) exists but unused in CI; it exposes `/healthz` instead of `/health`, so parity requires aligning monitoring endpoints.
- **Smoke selectors & expectations** (`tools/boot_smoke_test.mjs`): relies on `[data-ui="row-check"]`, `[data-ui="action-bar"]` with `data-visible`, `[data-action="merge"]`, `[data-ui="merge-modal"]`, `[data-qa="merge-confirm"]`, `[data-ui="calendar-export-ics"]`, optional `[data-ui="calendar-export-csv"]`. The script asserts diagnostics splash hidden, Toast/Confirm availability, navigation via hash + tabs, selection counts, merge confirm, kanban handler idempotence, pipeline filtering, calendar exports, `/__log` health, warn cap (<6), and capture of `window.__KANBAN_HANDLERS__` counters.
- **CI discipline**: `npm run verify:build` runs manifest audit → contract lint → smoke; any red must stop edits per playbook.

## UI & State Architecture
- **Routing**: `crm-app/js/app.js` defines `Router.goto`, enforces canonical hashes (`#/dashboard`, `#/pipeline`, etc.), handles hashchange idempotently (`suppressHashUpdate` guard), and bypasses canonical rewriting for Workbench (#/workbench). RenderGuard hooks reapply pipeline filters and DnD enhancers.
- **View activation**: `activate(view)` toggles `main` nodes, `data-ui` markers, resets selection (`clearAllSelectionScopes`), ensures mount functions executed once via `VIEW_LIFECYCLE`, and dispatches `app:navigate`/`app:view:changed` with previous view context.
- **Selection stack**:
  - Legacy `SelectionService` in `services/selection.js` maintains `state.ids`, toggles checkboxes on `raf`, dispatches `selection:changed` + updates `window.__SEL_COUNT__`.
  - `SelectionStore` (`state/selectionStore.js`) provides scope-specific sets and `app:data:changed` snapshots for watchers (partners mirror uses this).
  - `Selection` adapter (`services/selection_adapter.js`) bridges to whichever implementation exists, exposing `select/toggle/clear` while normalizing metrics.
- **Action bar**:
  - `ui/action_bar.js` ensures `[data-ui="action-bar"]`, injects inline style (duplicated in `state/actionBarGuards.js`), wires global FAB, listens for `[data-action]` clicks, and loads merge modal on demand.
  - `state/actionBarGuards.js` computes enablement thresholds (edit=1, merge=2, etc.), toggles classes, and injects the same inline style (risking double insertion and conflicting tokens).
  - Merge flow uses `ui/merge_modal.js` which enforces singleton modal (`ACTIVE_GUARD`), escapes HTML, dispatches `merge:*` events, and delegates to orchestrators from patches. Smoke depends on `[data-ui="merge-modal"]` + `[data-qa="merge-confirm"]` presence and unblocked confirm button.
- **Modal lifecycle**: Most modals convert legacy dialogs into div overlays (`partners_modal.js`, `contacts.js`), patching attributes and hooking escape handlers. `partner_edit_modal.js` adds focus trap + close buttons, hiding contact modals to avoid stacking.

## Partners Module
- **Entry path**: `partners/list.js` attaches delegated `click` to table body (`#tbl-partners`). When clicking `.partner-name` or `[data-partner-id]`, it extracts IDs, prevents default, and calls `openPartnerEditModal()` from `ui/partner_edit_modal.js`.
- **Modal boot**: `partners.js`’s `ensurePartnersBoot` queues ID requests in `window.__PARTNER_MODAL_QUEUE__` until `window.renderPartnerModal` exists, wires search filter, and mirrors selection store.
- **Singleton checks**: `ui/partner_edit_modal.js` removes extra `[data-ui="partner-edit-modal"]` nodes, hides contact modals, and focus traps `.dlg`. `openPartnerEditModal` first calls `closePartnerEditModal`, then removes extras and awaits legacy `openPartnerEdit` (which itself early-returns if same partner already open).
- **Duplication risks**:
  - `ensurePartnerModalRoot` clones legacy `<dialog>` into `<div>` wrapper; on repeated conversions across patches, race conditions could temporarily leave two nodes until `removeExtraPartnerModals` runs.
  - `openPartnerEdit` short-circuits if dataset indicates current ID, so queued opens while the dialog is still loading (before `dataset.partnerId` set) can drop events.
  - `partners.js` removal of advanced query forms manipulates DOM aggressively; no guard ensures elements stay removed if other scripts reinsert them.
- **Event delegation**: Both click listener and selection mirror rely on DOM ready hooks; `document.addEventListener('app:data:changed', rerun)` ensures rehydration but lacks `once` guard (only boolean flag). That is fine yet watchers accumulate if modules re-executed, though manifest should prevent multiple loads.

## Drag & Drop / Handler Idempotence
- **Pipeline kanban (`pipeline/kanban_dnd.js`)**:
  - Maintains `WIRED_BOARDS`, `BOARD_HANDLERS`, counters exposed via `window.__KANBAN_HANDLERS__` for smoke.
  - `cleanupDetachedBoards()` + `detachAll()` invoked before rewiring and on `app:navigate` away from pipeline, avoiding listener leaks.
  - `persistStage` normalizes stage labels, uses dynamic imports for DB helpers, writes updates, and coalesces `app:data:changed` dispatch via a queued set.
  - Stage chips re-render on drop; `RenderGuard` hook re-runs `wireKanbanDnD()` after paints, but `cards()` reassigns `draggable` each pass (idempotent).
- **Dashboard widgets (`dashboard/widgets_dnd.js`)**:
  - Uses `WIRED` + `WIRED_HOST` to avoid double binding, ensures each tile `draggable`, persists order to `localStorage` (`dash:widgets:v1`).
  - No explicit teardown on route exit; if the dashboard container re-renders to a fresh node, `WIRED_HOST !== host` resets `WIRED=false` but previous listeners remain on orphaned node until GC, though minimal risk.
  - RenderGuard hook re-calls `wireWidgetsDnD`; placeholder and drag state cleaned on `dragend`.
- **Quick add**: Not DnD but note: `ui/quick_add_unified.js` uses overlay; no attach-once guard beyond `window.__QUICK_ADD_GUARD__` (present), so fine.

## Calendar Export & CSV
- `calendar_actions.js` binds ICS/CSV buttons once DOM ready and on `calendar:exports:ready` / `app:view:changed`. Buttons call `CalendarExports.downloadIcs/Csv`.
- ICS generation: prefers `window.CRM_ICS.buildICS/downloadICS` (`calendar_ics.js`), else fallback builder writes `BEGIN:VCALENDAR` with `DTSTART;VALUE=DATE`. No timezone conversions beyond local midnight; all-day events only.
- CSV: header `Date,Type,Title,Details,Loan,Status,Source`. Data uses ISO date (UTC slice), event type, title, subtitle, loan label, status, `entity:id` string. Exports plain text, no BOM; Excel on Windows may mis-detect encoding.
- Data source: `calendar_impl.js` populates `CalendarAPI.visibleEvents()` from the last render snapshot. Export results only reflect currently visible range; there is no optional filter for entire pipeline.
- Missing pieces: no ICS UID persistence (generated from event/time), but that's acceptable. No error surface to user on fetch failures—just silent return.

## Workbench
- `pages/workbench.js` proxies to `workbench/index.js`, which lazy-mounts into `#route-root` and builds the Workbench shell on demand.
- Data fetch: `workbench/index.js` reads IndexedDB stores via `window.dbGetAll`, sorts by `updatedAt`, applies JSON filter criteria (`q`, stage, tier, partner, date ranges), and stores the snapshot for reuse.
- Saved queries: `workbench/queries_store.js` persists named queries to `localStorage` with an in-memory fallback so environments without storage still function. The UI supports create, update, delete per entity.
- Selection integration: result tables mark rows with `[data-selection-scope]` and wire click/checkbox handlers through `SelectionService`, keeping bulk actions aligned with existing selection tooling.
- CSV export: `workbenchExportCsv` assembles entity-specific columns, emits a Blob download, and logs soft warnings on failure without tripping the zero-error policy.
- Styling: layout relies on inline flex/grid definitions and status text for feedback; the shared action bar still does not render inside Workbench.

## Communications Surface
- Contact modal actions (`contacts/modal.js`) look up handlers in `window.CRM.channels/email|sms` etc. If absent, they fall back to toasts, leaving user without actual send path.
- Email compose flows (`patch_2025-09-26_phase2_automations.js`, `contacts.js`) still emit `mailto:` URLs and rely on `window.open`. No gating or feature flag for future adapters.
- SMS path similar; absence of actual handler silently no-ops (toast on failure). Suggest gating with capability flags and user feedback.
- Mass merge/email actions in `patch_20250926_ctc_actionbar.js` also emit `mailto:` BCC lists; there’s no service abstraction yet.

## Logging & Noise
- Despite the zero-error policy, many modules log recoverable issues via `console.error` (e.g., `app.js` automation surface, merge orchestrators, settings forms, importer). Boot hardener also wraps `console.error`, but numerous modules call it directly for UI issues.
- Some modules log toasts + `console.warn`, but others (e.g., `partners.js`, `contacts.js`) still `console.error` on missing dispatch functions.
- Recommendation: audit each `console.error` call, downgrade to `console.warn`/`info` unless it blocks boot or data integrity; align with Playbook (only import failures/HARD prerequisites should emit error).

## Windows Launcher
- `Start CRM.bat` / `Start-CRM.ps1` launch `node tools/dev_server.mjs` hidden. No guard prevents multiple instances; repeated clicks spawn multiple servers contending for ports (dev_server auto-finds ports, but no indicator returned to user).
- `.NET` WebView2 shell (optional) launches browser pointing to ephemeral port (output to stdout). No health-check or auto-restart; if Node server exits, shell stays blank. `/healthz` endpoint differs from `/health`, so existing monitors must know which server is running.
- Logs: Node server writes to `%LOCALAPPDATA%\CRM\logs`; shell has no integration with Windows Event Log.

## Testability
- Smoke test verifies boot, nav, selection, merge confirm, pipeline filter, kanban handler counters, calendar exports, `/__log` fallback, warn cap. It does **not** cover:
  - Partner modal open/close lifecycle or quick create flows.
  - Workbench rendering or self-test execution.
  - Widget DnD persistence (localStorage) beyond ensuring handler counts unchanged.
  - Communications actions (mailto/SMS) or reminders.
  - Calendar CSV contents (only checks for console errors on click).
- Existing canaries: `window.__KANBAN_HANDLERS__` stats, `window.__SEL_COUNT__`, and RenderGuard hook logs. Warn cap is enforced (≤5 warnings) but not source-specific, so improvements must keep warnings minimal.

## External Audit Comparison
| Claim | Evidence in Code | Agree? | Action |
| --- | --- | --- | --- |
| No outstanding orphan modules (reports/orphan_report.txt) | `reports/orphan_report.txt` lists none | Agree | Continue manifest hygiene; rerun audit after structural changes. |
| No duplicate `app:data:changed` listeners (same report) | Report explicitly states none | Agree | Maintain single attach flags when introducing new listeners. |
| No legacy calendar markers (same report) | Audit found none | Agree | Keep calendar DOM normalized; ensure new views follow same conventions. |
| *(No other external audit notes provided)* | — | — | Document future external findings alongside this table. |

## Prioritized Roadmap
### P1 — Critical Stabilizations
- **Acceptance**:
  - Partner modal always singleton even under rapid re-entry (no orphaned duplicate nodes, dataset set before queue drains).
  - Merge confirm path resilient: confirm button stays enabled once selection>=2, and modal resolves promises consistently.
  - Launcher docs clarify single-instance expectations; optionally guard double-launch or surface port info.
- **Touch Points**: `crm-app/js/ui/partner_edit_modal.js`, `crm-app/js/partners_modal.js`, `crm-app/js/ui/action_bar.js`, `crm-app/js/state/actionBarGuards.js`, Windows launcher scripts.
- **Constraints**: Preserve smoke selectors; do not remove `[data-ui="merge-modal"]` or alter action bar data attributes.

### P2 — Idempotent Handlers & Route Resilience
- **Acceptance**:
  - Ensure DnD handlers detach when hosts removed (dashboard widgets) and reattach without duplicate listeners.
  - Selection/action bar styles injected once; moving between routes does not accumulate duplicate `<style>` tags.
  - Pipeline filters reapply reliably after hash manipulations and `app:data:changed` bursts without console noise.
- **Touch Points**: `dashboard/widgets_dnd.js`, `ui/action_bar.js`, `state/actionBarGuards.js`, `app.js` pipeline filter helpers.
- **Constraints**: Keep `window.__KANBAN_HANDLERS__` counters stable across smoke nav.

### P3 — Export Improvements & Quick Visual Tweaks
- **Acceptance**:
  - Calendar CSV exports with BOM and user feedback on completion/failure; ICS builder documents timezone assumptions.
  - Calendar export buttons maintain stable placement/spacing; action bar visually centered with no duplicate styles.
  - Quick-create affordance (e.g., Quick Add) remains accessible post tweaks.
- **Touch Points**: `calendar_actions.js`, `calendar_ics.js`, `styles.css` (action bar area), `ui/action_bar.js` (layout adjustments).
- **Constraints**: Keep smoke’s calendar export clicks side-effect free (no additional dialogs breaking tests).

### P4 — Workbench MVP Enhancements
- **Acceptance**:
  - Saved filters (at least one) persisted per scope via localStorage.
  - Manual “Run” button executes saved filter and updates tables.
  - CSV export for Workbench tables.
  - Shared action bar reuse when selection present (without conflicting global bar).
- **Touch Points**: `pages/workbench.js`, `styles.css`, possible new `workbench` util modules.
- **Constraints**: Ensure added UI hidden when Workbench not active; avoid interfering with smoke nav (Workbench not visited in smoke but keep nav stable).

### P5 — Widgets Drag & Drop Persistence Polish
- **Acceptance**:
  - Dashboard DnD persists order across reloads and route toggles without leaking listeners.
  - Provide “Reset layout” UI acknowledging localStorage usage.
  - Handler counters/metrics for diagnostics accessible (similar to kanban).
- **Touch Points**: `dashboard/widgets_dnd.js`, `index.html` (button), `styles.css`.
- **Constraints**: Keep smoke’s widget handler count unchanged (test checks for idempotence via `__KANBAN_HANDLERS__` only, but avoid extra warnings).

### P6 — Communications Placeholder Hardening
- **Acceptance**:
  - Detect missing email/SMS adapters and present actionable toast/modal (not silent success).
  - Central capability flag gating `mailto` fallback vs future adapters.
- **Touch Points**: `contacts/modal.js`, `patch_2025-09-26_phase2_automations.js`, `patch_20250926_ctc_actionbar.js` (bulk email), `contacts.js` (mailto flows).
- **Constraints**: Do not remove existing mailto functionality; smoke has no coverage but ensure zero new console errors.

### P7 — Adapter Behind Feature Flag
- **Acceptance**:
  - Introduce configurable adapter interface (e.g., `window.CRM.adapters.communication`) toggled via env/flag.
  - Provide no-op default behind flag until real service wired.
- **Touch Points**: New adapter module under `crm-app/js/services`, updates to communication entry points.
- **Constraints**: Feature flag default off to avoid impacting current flows; maintain zero-warning smoke run.

---

## Stabilization Plan
- **Proposed branch**: `audit/stabilize-foundations`
- **Sequential PR plan** (each PR → `npm run verify:build`):
  1. "Harden partner modal singleton and merge confirm guards" → `npm run verify:build`
  2. "Deduplicate action bar styles and detach widget DnD listeners" → `npm run verify:build`
  3. "Calendar exports polish (BOM + UX copy)" → `npm run verify:build`
  4. "Workbench filters & CSV scaffolding" → `npm run verify:build`
  5. "Dashboard widget layout persistence polish" → `npm run verify:build`
  6. "Communications capability warnings" → `npm run verify:build`
  7. "Introduce communications adapter flag" → `npm run verify:build`
