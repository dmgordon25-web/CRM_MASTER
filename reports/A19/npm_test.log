npm warn Unknown env config "http-proxy". This will stop working in the next major version of npm.

> crmtool@0.1.0 test:unit
> vitest run --config vitest.config.mjs


 RUN  v0.34.6 /workspace/CRM_MASTER

 ❯ tests/unit/calendar_dnd.spec.ts  (4 tests | 4 failed) 1831ms
   ❯ tests/unit/calendar_dnd.spec.ts > calendar drag classification > classifies user events as draggable and locks fixed events
     → document.querySelectorAll is not a function
   ❯ tests/unit/calendar_dnd.spec.ts > calendar drag classification > prefers raw reschedule handlers when persisting a move
     → document.querySelectorAll is not a function
   ❯ tests/unit/calendar_dnd.spec.ts > calendar drag classification > falls back to CalendarAPI persistence when no raw handler exists
     → document.querySelectorAll is not a function
   ❯ tests/unit/calendar_dnd.spec.ts > calendar drag classification > binds drag handlers for draggable events only
     → document.querySelectorAll is not a function
 ❯ tests/unit/renderGuard.spec.ts  (4 tests | 3 failed) 2043ms
   ❯ tests/unit/renderGuard.spec.ts > App render coordination > refreshes partners without triggering a global render
     → button.removeAttribute is not a function
   ❯ tests/unit/renderGuard.spec.ts > App render coordination > coalesces partial partners change events
     → button.removeAttribute is not a function
   ❯ tests/unit/renderGuard.spec.ts > App render coordination > falls back to global render when scope not handled
     → button.removeAttribute is not a function
 ❯ tests/unit/calendar_impl.spec.ts  (2 tests | 2 failed) 556ms
   ❯ tests/unit/calendar_impl.spec.ts > calendar loan legend > exposes a stable loan palette mapping
     → document.querySelectorAll is not a function
   ❯ tests/unit/calendar_impl.spec.ts > calendar loan legend > normalizes loan types into the palette keys
     → document.querySelectorAll is not a function
 ❯ tests/unit/uiStringsUsage.spec.ts  (3 tests | 2 failed) 941ms
   ❯ tests/unit/uiStringsUsage.spec.ts > UI modules consume STR > quick_add pulls modal copy from STR
     → expected "spy" to be called at least once
   ❯ tests/unit/uiStringsUsage.spec.ts > UI modules consume STR > calendar implementation uses STR entries
     → render is not a function
 ❯ tests/unit/pipelineStages.spec.ts  (3 tests | 3 failed) 120ms
   ❯ tests/unit/pipelineStages.spec.ts > pipelineStages normalizeStage > normalizes common aliases
     → expected 'Long Shot' to be 'CTC' // Object.is equality
   ❯ tests/unit/pipelineStages.spec.ts > pipelineStages normalizeStage > warns only once for unknown values and defaults to Processing
     → expected 'Long Shot' to be 'Processing' // Object.is equality
   ❯ tests/unit/pipelineStages.spec.ts > pipelineStages normalizeStage > exposes canonical key helpers
     → expected 'long-shot' to be 'cleared-to-close' // Object.is equality
 ❯ tests/unit/quickAdd.spec.ts  (2 tests | 2 failed) 447ms
   ❯ tests/unit/quickAdd.spec.ts > Unified Quick Add modal > saves contacts via Contacts.createQuick and dispatches a single repaint
     → contactForm.querySelector is not a function
   ❯ tests/unit/quickAdd.spec.ts > Unified Quick Add modal > falls back to dbPut for partners when createQuick is unavailable
     → contactForm.querySelector is not a function
 ❯ tests/unit/contacts_merge.spec.ts  (2 tests | 2 failed) 208ms
   ❯ tests/unit/contacts_merge.spec.ts > contact merge UI > resolves conflicting fields and preserves extras from both contacts
     → expected undefined to be truthy
   ❯ tests/unit/contacts_merge.spec.ts > contact merge UI > merges records, rewires linked items, and dispatches once
     → Cannot read properties of undefined (reading 'createState')
 ❯ tests/unit/convertLongShotToPipeline.spec.ts  (1 test | 1 failed) 141ms
   ❯ tests/unit/convertLongShotToPipeline.spec.ts > convertLongShotToPipeline > promotes a Long Shot contact into the pipeline with a single dispatch
     → expected 'undefined' to be 'function' // Object.is equality
 ❯ tests/unit/toast.spec.ts  (1 test | 1 failed) 93ms
   ❯ tests/unit/toast.spec.ts > Toast host > coalesces duplicate show calls within 500ms
     → document.createElementNS is not a function
 ✓ tests/unit/importer_dryrun.spec.ts  (2 tests) 62ms
 ❯ tests/unit/settings.test.js  (5 tests | 5 failed) 83ms
   ❯ tests/unit/settings.test.js > Settings data access > merges partial saves, persists to IndexedDB, and dispatches once per save
     → Unexpected token 'export'
   ❯ tests/unit/settings.test.js > Settings data access > normalizes dashboard preferences and merges widget visibility
     → Unexpected token 'export'
   ❯ tests/unit/settings.test.js > Settings data access > invokes the toast API after a successful save
     → Unexpected token 'export'
   ❯ tests/unit/settings.test.js > Settings data access > falls back to dispatchEvent when no dispatcher is registered
     → Unexpected token 'export'
   ❯ tests/unit/settings.test.js > Settings data access > round-trips goals, signature, and profile with one dispatch per save
     → Unexpected token 'export'
 ❯ tests/unit/accessibilityTokens.test.js  (3 tests | 1 failed) 26ms
   ❯ tests/unit/accessibilityTokens.test.js > accessibility tokens > defines a base font size of at least 16px
     → body font size token should exist: expected null to be truthy
 ❯ tests/unit/formFooter.spec.ts  (2 tests | 2 failed) 63ms
   ❯ tests/unit/formFooter.spec.ts > FormFooter > renders cancel then save buttons and emits events once
     → Failed to load url ../../crm-app/js/ui/FormFooter.tsx (resolved id: ../../crm-app/js/ui/FormFooter.tsx). Does the file exist?
   ❯ tests/unit/formFooter.spec.ts > FormFooter > maps Enter and Escape to save and cancel actions
     → Failed to load url ../../crm-app/js/ui/FormFooter.tsx (resolved id: ../../crm-app/js/ui/FormFooter.tsx). Does the file exist?
 ❯ tests/unit/dashboardFocus.test.js  (3 tests | 3 failed) 42ms
   ❯ tests/unit/dashboardFocus.test.js > Dashboard focus layout > renders Today view with focus widgets and hides secondary sections by default
     → Unexpected token 'export'
   ❯ tests/unit/dashboardFocus.test.js > Dashboard focus layout > switches to All mode and shows configured widgets
     → Unexpected token 'export'
   ❯ tests/unit/dashboardFocus.test.js > Dashboard focus layout > persists widget visibility toggles across reloads
     → Unexpected token 'export'
 ❯ tests/unit/actionBarGuards.spec.ts  (4 tests | 1 failed) 74ms
   ❯ tests/unit/actionBarGuards.spec.ts > computeActionBarGuards > keeps bulk actions enabled for more than two selections
     → expected { edit: false, merge: true, …(7) } to deeply equal { edit: false, merge: false, …(7) }
stdout | tests/unit/updateContactStage.spec.ts > updateContactStage > persists stage transitions and emits exactly one app:data:changed
[patch_2025-09-26_phase1_pipeline_partners.init] complete

stdout | tests/unit/updateContactStage.spec.ts > updateContactStage > restores previous stage metadata when reverting
[patch_2025-09-26_phase1_pipeline_partners.init] complete

 ✓ tests/unit/updateContactStage.spec.ts  (2 tests) 748ms
 ✓ tests/unit/dashboardLayoutPersistence.test.js  (2 tests) 358ms
 ✓ tests/unit/importer_dedupe.spec.ts  (2 tests) 156ms
 ✓ tests/unit/notifications.spec.ts  (2 tests) 83ms
 ✓ tests/unit/ical.spec.ts  (1 test) 100ms
 ✓ tests/unit/importer.test.js  (8 tests) 98ms
 ✓ tests/unit/softDelete.spec.ts  (3 tests) 165ms
 ✓ tests/unit/commissions_listener.spec.ts  (2 tests) 74ms
 ✓ tests/unit/importer_trunc.spec.ts  (2 tests) 114ms
 ✓ tests/unit/selectionStore.spec.ts  (3 tests) 36ms
 ✓ tests/unit/merge_partners.spec.ts  (2 tests) 50ms
 ✓ tests/unit/seedDemoData.spec.ts  (2 tests) 25ms
 ✓ tests/unit/exporter.spec.ts  (1 test) 23ms
 ✓ tests/unit/strings.spec.ts  (2 tests) 31ms
 ✓ tests/unit/bootstrap.test.js  (1 test) 8ms

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯ Failed Tests 32 ⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯

 FAIL  tests/unit/accessibilityTokens.test.js > accessibility tokens > defines a base font size of at least 16px
AssertionError: body font size token should exist: expected null to be truthy

- Expected: 
null

+ Received: 
false

 ❯ tests/unit/accessibilityTokens.test.js:15:56
     13|   it('defines a base font size of at least 16px', () => {
     14|     const match = tokensSource.match(/--body-font-size:\s*([0-9.]+)px/…
     15|     expect(match, 'body font size token should exist').toBeTruthy();
       |                                                        ^
     16|     expect(Number(match[1])).toBeGreaterThanOrEqual(16);
     17|   });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/32]⎯

 FAIL  tests/unit/actionBarGuards.spec.ts > computeActionBarGuards > keeps bulk actions enabled for more than two selections
AssertionError: expected { edit: false, merge: true, …(7) } to deeply equal { edit: false, merge: false, …(7) }

- Expected
+ Received

  Object {
    "addTask": true,
    "bulkLog": true,
    "clear": true,
    "convertToPipeline": false,
    "delete": true,
    "edit": false,
    "emailMass": true,
    "emailTogether": true,
-   "merge": false,
+   "merge": true,
  }

 ❯ tests/unit/actionBarGuards.spec.ts:53:20
     51|   it('keeps bulk actions enabled for more than two selections', () => {
     52|     const guards = computeActionBarGuards(4);
     53|     expect(guards).toEqual({
       |                    ^
     54|       edit: false,
     55|       merge: false,

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/32]⎯

 FAIL  tests/unit/calendar_dnd.spec.ts > calendar drag classification > classifies user events as draggable and locks fixed events
 FAIL  tests/unit/calendar_dnd.spec.ts > calendar drag classification > prefers raw reschedule handlers when persisting a move
 FAIL  tests/unit/calendar_dnd.spec.ts > calendar drag classification > falls back to CalendarAPI persistence when no raw handler exists
 FAIL  tests/unit/calendar_dnd.spec.ts > calendar drag classification > binds drag handlers for draggable events only
 FAIL  tests/unit/calendar_impl.spec.ts > calendar loan legend > exposes a stable loan palette mapping
 FAIL  tests/unit/calendar_impl.spec.ts > calendar loan legend > normalizes loan types into the palette keys
TypeError: document.querySelectorAll is not a function
 ❯ closePartnerRouteDialogs crm-app/js/partners.js:306:14
    304|   function closePartnerRouteDialogs(){
    305|     if (typeof document === 'undefined') return;
    306|     document.querySelectorAll('dialog[open]').forEach(dialog => {
       |              ^
    307|       let allowed = false;
    308|       try {
 ❯ ensurePartnersBoot crm-app/js/partners.js:359:3
 ❯ crm-app/js/partners.js:1155:1
 ❯ crm-app/js/ui/partner_edit_modal.js:5:31

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/32]⎯

 FAIL  tests/unit/contacts_merge.spec.ts > contact merge UI > resolves conflicting fields and preserves extras from both contacts
AssertionError: expected undefined to be truthy

- Expected: 
undefined

+ Received: 
false

 ❯ tests/unit/contacts_merge.spec.ts:75:19
     73|     await import(MODULE_PATH);
     74|     const hooks = (window as any).__CONTACT_MERGE_TEST__;
     75|     expect(hooks).toBeTruthy();
       |                   ^
     76| 
     77|     const contactA: ContactRecord = {

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/32]⎯

 FAIL  tests/unit/contacts_merge.spec.ts > contact merge UI > merges records, rewires linked items, and dispatches once
TypeError: Cannot read properties of undefined (reading 'createState')
 ❯ tests/unit/contacts_merge.spec.ts:183:25
    181|     const dialogStub = { close: vi.fn(), removeAttribute: vi.fn(), sty…
    182| 
    183|     const state = hooks.createState([
       |                         ^
    184|       clone(contactsStore.get('keep')),
    185|       clone(contactsStore.get('drop'))

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/32]⎯

 FAIL  tests/unit/convertLongShotToPipeline.spec.ts > convertLongShotToPipeline > promotes a Long Shot contact into the pipeline with a single dispatch
AssertionError: expected 'undefined' to be 'function' // Object.is equality

- Expected
+ Received

- function
+ undefined

 ❯ tests/unit/convertLongShotToPipeline.spec.ts:146:28
    144| 
    145|     const convert = (windowStub as any).convertLongShotToPipeline;
    146|     expect(typeof convert).toBe('function');
       |                            ^
    147| 
    148|     const result = await convert('c1');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/32]⎯

 FAIL  tests/unit/dashboardFocus.test.js > Dashboard focus layout > renders Today view with focus widgets and hides secondary sections by default
 FAIL  tests/unit/dashboardFocus.test.js > Dashboard focus layout > switches to All mode and shows configured widgets
 FAIL  tests/unit/dashboardFocus.test.js > Dashboard focus layout > persists widget visibility toggles across reloads
SyntaxError: Unexpected token 'export'
 ❯ new Script node:vm:117:7
 ❯ createScript node:vm:269:10
 ❯ Object.runInThisContext node:vm:317:10
 ❯ runScript tests/unit/dashboardFocus.test.js:14:6
     12| function runScript(relativePath) {
     13|   const code = readFileSync(join(jsRoot, relativePath), 'utf8');
     14|   vm.runInThisContext(code, { filename: relativePath });
       |      ^
     15| }
     16| 
 ❯ resetEnvironment tests/unit/dashboardFocus.test.js:320:3
 ❯ tests/unit/dashboardFocus.test.js:385:5

Module db.js:482 seems to be an ES Module but shipped in a CommonJS package. You might want to create an issue to the package "db.js:482" asking them to ship the file in .mjs extension or add "type": "module" in their package.json.

As a temporary workaround you can try to inline the package by updating your config:

// vitest.config.js
export default {
  test: {
    server: {
      deps: {
        inline: [
          "db.js:482"
        ]
      }
    }
  }
}

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[7/32]⎯

 FAIL  tests/unit/formFooter.spec.ts > FormFooter > renders cancel then save buttons and emits events once
 FAIL  tests/unit/formFooter.spec.ts > FormFooter > maps Enter and Escape to save and cancel actions
Error: Failed to load url ../../crm-app/js/ui/FormFooter.tsx (resolved id: ../../crm-app/js/ui/FormFooter.tsx). Does the file exist?
 ❯ loadAndTransform node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:51968:17

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[8/32]⎯

 FAIL  tests/unit/pipelineStages.spec.ts > pipelineStages normalizeStage > normalizes common aliases
AssertionError: expected 'Long Shot' to be 'CTC' // Object.is equality

- Expected
+ Received

- CTC
+ Long Shot

 ❯ tests/unit/pipelineStages.spec.ts:30:75
     28|     expect((globalThis as any).window.normalizeStage('Pre App')).toBe(…
     29|     expect((globalThis as any).window.normalizeStage('c.t.c.')).toBe('…
     30|     expect((globalThis as any).window.normalizeStage('Cleared to Close…
       |                                                                           ^
     31|     expect((globalThis as any).window.normalizeStage('funding')).toBe(…
     32|     expect(warnSpy).not.toHaveBeenCalled();

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[9/32]⎯

 FAIL  tests/unit/pipelineStages.spec.ts > pipelineStages normalizeStage > warns only once for unknown values and defaults to Processing
AssertionError: expected 'Long Shot' to be 'Processing' // Object.is equality

- Expected
+ Received

- Processing
+ Long Shot

 ❯ tests/unit/pipelineStages.spec.ts:39:45
     37|     const { warnSpy } = await loadModule();
     38|     const normalizeStage = (globalThis as any).window.normalizeStage;
     39|     expect(normalizeStage('unknown-stage')).toBe('Processing');
       |                                             ^
     40|     expect(normalizeStage('another mystery')).toBe('Processing');
     41|     expect(warnSpy).toHaveBeenCalledTimes(1);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[10/32]⎯

 FAIL  tests/unit/pipelineStages.spec.ts > pipelineStages normalizeStage > exposes canonical key helpers
AssertionError: expected 'long-shot' to be 'cleared-to-close' // Object.is equality

- Expected
+ Received

- cleared-to-close
+ long-shot

 ❯ tests/unit/pipelineStages.spec.ts:50:51
     48|     const stageLabelFromKey = (globalThis as any).window.stageLabelFro…
     49|     expect(stageKeyFromLabel('Pre-Approved')).toBe('preapproved');
     50|     expect(stageKeyFromLabel('cleared-to-close')).toBe('cleared-to-clo…
       |                                                   ^
     51|     expect(stageKeyFromLabel('Lead')).toBe('lead');
     52|     expect(stageLabelFromKey('cleared-to-close')).toBe('CTC');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[11/32]⎯

 FAIL  tests/unit/quickAdd.spec.ts > Unified Quick Add modal > saves contacts via Contacts.createQuick and dispatches a single repaint
TypeError: contactForm.querySelector is not a function
 ❯ Object.open crm-app/js/ui/quick_add_unified.js:198:54
    196|     const partnerForm = node.querySelector('.qa-form[data-kind="partne…
    197| 
    198|     const contactSaveBtn = contactForm ? contactForm.querySelector('.q…
       |                                                      ^
    199|     let contactSaving = false;
    200|     const contactValidation = contactForm
 ❯ tests/unit/quickAdd.spec.ts:144:38

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[12/32]⎯

 FAIL  tests/unit/quickAdd.spec.ts > Unified Quick Add modal > falls back to dbPut for partners when createQuick is unavailable
TypeError: contactForm.querySelector is not a function
 ❯ Object.open crm-app/js/ui/quick_add_unified.js:198:54
    196|     const partnerForm = node.querySelector('.qa-form[data-kind="partne…
    197| 
    198|     const contactSaveBtn = contactForm ? contactForm.querySelector('.q…
       |                                                      ^
    199|     let contactSaving = false;
    200|     const contactValidation = contactForm
 ❯ tests/unit/quickAdd.spec.ts:164:38

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[13/32]⎯

 FAIL  tests/unit/renderGuard.spec.ts > App render coordination > refreshes partners without triggering a global render
 FAIL  tests/unit/renderGuard.spec.ts > App render coordination > coalesces partial partners change events
 FAIL  tests/unit/renderGuard.spec.ts > App render coordination > falls back to global render when scope not handled
TypeError: button.removeAttribute is not a function
 ❯ ensureLayoutResetButton crm-app/js/dashboard/index.js:585:14
    583|       delete button.dataset.loading;
    584|     } else {
    585|       button.removeAttribute('data-loading');
       |              ^
    586|     }
    587|   }
 ❯ ensureLayoutToggle crm-app/js/dashboard/index.js:756:3
 ❯ init crm-app/js/dashboard/index.js:3206:7
 ❯ crm-app/js/dashboard/index.js:3234:1
 ❯ crm-app/js/app.js:1:31

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[14/32]⎯

 FAIL  tests/unit/settings.test.js > Settings data access > merges partial saves, persists to IndexedDB, and dispatches once per save
 FAIL  tests/unit/settings.test.js > Settings data access > normalizes dashboard preferences and merges widget visibility
 FAIL  tests/unit/settings.test.js > Settings data access > invokes the toast API after a successful save
 FAIL  tests/unit/settings.test.js > Settings data access > falls back to dispatchEvent when no dispatcher is registered
 FAIL  tests/unit/settings.test.js > Settings data access > round-trips goals, signature, and profile with one dispatch per save
SyntaxError: Unexpected token 'export'
 ❯ new Script node:vm:117:7
 ❯ createScript node:vm:269:10
 ❯ Object.runInThisContext node:vm:317:10
 ❯ runScript tests/unit/settings.test.js:14:6
     12| function runScript(relativePath) {
     13|   const code = readFileSync(join(jsRoot, relativePath), 'utf8');
     14|   vm.runInThisContext(code, { filename: relativePath });
       |      ^
     15| }
     16| 
 ❯ resetEnvironment tests/unit/settings.test.js:90:3
 ❯ tests/unit/settings.test.js:98:3

Module db.js:482 seems to be an ES Module but shipped in a CommonJS package. You might want to create an issue to the package "db.js:482" asking them to ship the file in .mjs extension or add "type": "module" in their package.json.

As a temporary workaround you can try to inline the package by updating your config:

// vitest.config.js
export default {
  test: {
    server: {
      deps: {
        inline: [
          "db.js:482"
        ]
      }
    }
  }
}

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[15/32]⎯

 FAIL  tests/unit/toast.spec.ts > Toast host > coalesces duplicate show calls within 500ms
TypeError: document.createElementNS is not a function
 ❯ createIconSvg crm-app/js/ui/Toast.js:56:26
     54| 
     55|   function createIconSvg(key, path){
     56|     const svg = document.createElementNS(SVG_NS, 'svg');
       |                          ^
     57|     svg.setAttribute('viewBox', '0 0 24 24');
     58|     svg.setAttribute('aria-hidden', 'true');
 ❯ getToastIcon crm-app/js/ui/Toast.js:81:31
 ❯ ToastController.show crm-app/js/ui/Toast.js:159:22
 ❯ tests/unit/toast.spec.ts:59:11

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[16/32]⎯

 FAIL  tests/unit/uiStringsUsage.spec.ts > UI modules consume STR > quick_add pulls modal copy from STR
AssertionError: expected "spy" to be called at least once
 ❯ tests/unit/uiStringsUsage.spec.ts:107:39
    105|     doc.querySelector = vi.fn((selector: string) => selector === '[dat…
    106|     await import('../../crm-app/js/quick_add.js');
    107|     expect(quickBtn.addEventListener).toHaveBeenCalled();
       |                                       ^
    108|     const handler = quickBtn.addEventListener.mock.calls[0][1];
    109|     handler({ preventDefault: vi.fn() });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[17/32]⎯

 FAIL  tests/unit/uiStringsUsage.spec.ts > UI modules consume STR > calendar implementation uses STR entries
TypeError: render is not a function
 ❯ tests/unit/uiStringsUsage.spec.ts:143:11
    141|     await import('../../crm-app/js/calendar_impl.js');
    142|     const render = windowStub.__CALENDAR_IMPL__.render as Function;
    143|     await render(new Date(), 'month');
       |           ^
    144|     expect(used).toContain('calendar.legend.event-types');
    145|     expect(used).toContain('calendar.event.follow-up');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[18/32]⎯

 Test Files  14 failed | 16 passed (30)
      Tests  32 failed | 44 passed (76)
   Start at  22:16:21
   Duration  24.25s (transform 1.91s, setup 153ms, collect 3.20s, tests 8.80s, environment 15ms, prepare 8.93s)

