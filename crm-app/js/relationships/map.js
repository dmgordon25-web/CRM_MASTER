const MAX_NODES=200;const NONE_PARTNER='00000000-0000-none-partner-000000000000';const soon=typeof queueMicrotask==='function'?queueMicrotask:(fn)=>Promise.resolve().then(fn);
const norm=(v)=>String(v??'').trim();const text=(v,f='')=>{const out=norm(v);return out||f;};const arr=(v)=>Array.isArray(v)?v:[];
const contactName=(c)=>{if(!c)return'Contact';const combo=`${text(c.first||c.firstName)} ${text(c.last||c.lastName)}`.trim();return combo||text(c.name)||text(c.company)||text(c.email)||text(c.phone)||(c.id?`Contact ${c.id}`:'Contact');};
const partnerName=(p,id)=>{if(!p)return id?`Partner ${id}`:'Partner';const combo=`${text(p.first||p.firstName)} ${text(p.last||p.lastName)}`.trim();return text(p.company)||text(p.name)||combo||text(p.email)||text(p.phone)||(id?`Partner ${id}`:'Partner');};
const syncDiagnostics=()=>{if(typeof window==='undefined'||typeof document==='undefined')return;const nodes=document.querySelectorAll('[data-qa="rel-node"]').length;const edges=document.querySelectorAll('[data-qa="rel-edge"]').length;const keyboardAccess=!!document.querySelector('[data-qa="rel-node"][tabindex="0"]');window.__REL_DEBUG__={nodes,edges,keyboardAccess};try{console.log('REL_SUMMARY',window.__REL_DEBUG__);}catch(_err){}};
const buildDataset=({contacts=[],partners=[],noneId=NONE_PARTNER})=>{const skip=norm(noneId);const partnerById=new Map();for(const partner of partners){const id=norm(partner&&partner.id);if(id&&!partnerById.has(id))partnerById.set(id,partner);}const seen=new Set();const contactNodes=[];const partnerCounts=new Map();const edges=[];for(const contact of contacts){const contactId=norm(contact&&contact.id);if(!contactId||seen.has(contactId))continue;seen.add(contactId);const linkSet=new Set();for(const key of['partnerId','primaryPartnerId','buyerPartnerId','listingPartnerId','referralPartnerId']){const id=norm(contact&&contact[key]);if(id&&id!==skip)linkSet.add(id);}for(const value of arr(contact&&contact.partnerIds)){const id=norm(value);if(id&&id!==skip)linkSet.add(id);}if(!linkSet.size)continue;contactNodes.push({id:contactId,name:contactName(contact),count:linkSet.size,detail:text(contact&&(contact.stage||contact.pipelineStage||contact.status))});for(const partnerId of linkSet){if(!partnerById.has(partnerId))partnerById.set(partnerId,{id:partnerId});partnerCounts.set(partnerId,(partnerCounts.get(partnerId)||0)+1);edges.push({contactId,partnerId});}}const partnerNodes=Array.from(partnerCounts.entries()).map(([id,count])=>{const record=partnerById.get(id)||null;return{id,name:partnerName(record,id),count,detail:text(record&&(record.focus||record.partnerType||record.tier))};});contactNodes.sort((a,b)=>a.name.localeCompare(b.name,undefined,{sensitivity:'base'}));partnerNodes.sort((a,b)=>a.name.localeCompare(b.name,undefined,{sensitivity:'base'}));return{contactNodes,partnerNodes,edges};};
const buildNode=(type,node)=>{const button=document.createElement('button');button.type='button';button.className=`rel-node rel-${type}`;button.dataset.qa='rel-node';button.dataset.relType=type;button.dataset.relId=node.id;button.dataset.relKey=`${type}:${node.id}`;button.tabIndex=0;button.setAttribute('aria-label',`${node.name} — ${node.count} link${node.count===1?'':'s'}`);const label=document.createElement('span');label.className='rel-node-label';label.textContent=node.name;button.appendChild(label);if(node.detail){const detail=document.createElement('span');detail.className='rel-node-detail';detail.textContent=node.detail;button.appendChild(detail);}const badge=document.createElement('span');badge.className='rel-node-count';badge.textContent=`${node.count}`;button.appendChild(badge);return button;};
const renderFallback=(root,dataset,handlers)=>{if(root.__relCleanup)try{root.__relCleanup();}catch(_err){}root.innerHTML='';root.classList.remove('rel-map-root');root.classList.add('rel-map-fallback');const wrap=document.createElement('div');wrap.className='rel-fallback-shell';const title=document.createElement('h4');title.className='rel-fallback-title';title.textContent='Zoom to search';wrap.appendChild(title);const help=document.createElement('p');help.className='rel-fallback-help';help.textContent='Too many links to render at once. Search to open a record.';wrap.appendChild(help);const label=document.createElement('label');label.className='rel-fallback-search';label.textContent='Search contacts or partners';const input=document.createElement('input');input.type='search';input.setAttribute('aria-label','Search contacts or partners');label.appendChild(input);wrap.appendChild(label);const list=document.createElement('ul');list.className='rel-fallback-results';wrap.appendChild(list);const items=[...dataset.partnerNodes.map((node)=>({type:'partner',node})),...dataset.contactNodes.map((node)=>({type:'contact',node}))];const draw=(query)=>{const needle=norm(query).toLowerCase();list.innerHTML='';const matches=needle?items.filter(({node})=>[node.name,node.detail,node.id].some((value)=>norm(value).toLowerCase().includes(needle))):items.slice(0,40);matches.slice(0,60).forEach(({type,node})=>{const li=document.createElement('li');const btn=document.createElement('button');btn.type='button';btn.className=`rel-fallback-node rel-${type}`;btn.dataset.qa='rel-node';btn.dataset.relType=type;btn.dataset.relId=node.id;btn.tabIndex=0;btn.textContent=node.detail?`${node.name} — ${node.detail}`:node.name;btn.addEventListener('click',()=>type==='partner'?handlers.openPartner(node.id):handlers.openContact(node.id));li.appendChild(btn);list.appendChild(li);});};input.addEventListener('input',()=>draw(input.value));draw('');root.appendChild(wrap);root.__relCleanup=null;syncDiagnostics();};
const renderMap=(root,dataset,handlers)=>{if(root.__relCleanup)try{root.__relCleanup();}catch(_err){}root.innerHTML='';root.classList.remove('rel-map-fallback');root.classList.add('rel-map-root');const board=document.createElement('div');board.className='rel-map-board';root.appendChild(board);const columns=document.createElement('div');columns.className='rel-map-columns';board.appendChild(columns);const partnersCol=document.createElement('div');partnersCol.className='rel-map-column rel-partners';columns.appendChild(partnersCol);const contactsCol=document.createElement('div');contactsCol.className='rel-map-column rel-contacts';columns.appendChild(contactsCol);const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');svg.classList.add('rel-map-edges');svg.setAttribute('aria-hidden','true');board.appendChild(svg);const nodes=new Map();const links=new Map();const segments=[];let active='';const attach=(key,entry)=>{const list=links.get(key);if(list)list.push(entry);else links.set(key,[entry]);};const clear=()=>{if(!active)return;const current=nodes.get(active);if(current)current.classList.remove('is-active');nodes.forEach((node)=>node.classList.remove('is-linked'));segments.forEach(({line})=>line.classList.remove('is-linked'));active='';};const focus=(key)=>{if(active===key)return;clear();active=key;const node=nodes.get(key);if(!node)return;node.classList.add('is-active');(links.get(key)||[]).forEach(({target,line})=>{const other=nodes.get(target);if(other)other.classList.add('is-linked');if(line)line.classList.add('is-linked');});};const bind=(element,key,open)=>{nodes.set(key,element);if(!links.has(key))links.set(key,[]);element.addEventListener('mouseenter',()=>focus(key));element.addEventListener('focus',()=>focus(key));element.addEventListener('blur',()=>soon(()=>{const activeElement=typeof document!=='undefined'?document.activeElement:null;if(!activeElement||!board.contains(activeElement))clear();}));element.addEventListener('click',open);};dataset.partnerNodes.forEach((node)=>{const button=buildNode('partner',node);bind(button,`partner:${node.id}`,()=>handlers.openPartner(node.id));partnersCol.appendChild(button);});dataset.contactNodes.forEach((node)=>{const button=buildNode('contact',node);bind(button,`contact:${node.id}`,()=>handlers.openContact(node.id));contactsCol.appendChild(button);});dataset.edges.forEach((edge)=>{const line=document.createElementNS('http://www.w3.org/2000/svg','line');line.classList.add('rel-edge');line.dataset.qa='rel-edge';line.dataset.relPartnerId=edge.partnerId;line.dataset.relContactId=edge.contactId;svg.appendChild(line);const partnerKey=`partner:${edge.partnerId}`;const contactKey=`contact:${edge.contactId}`;attach(partnerKey,{target:contactKey,line});attach(contactKey,{target:partnerKey,line});segments.push({edge,line});});const updateLines=()=>{const bounds=board.getBoundingClientRect();const width=Math.max(bounds.width,1);const height=Math.max(bounds.height,1);svg.setAttribute('viewBox',`0 0 ${width} ${height}`);svg.setAttribute('width',width);svg.setAttribute('height',height);segments.forEach(({edge,line})=>{const partnerNode=nodes.get(`partner:${edge.partnerId}`);const contactNode=nodes.get(`contact:${edge.contactId}`);if(!partnerNode||!contactNode){line.setAttribute('opacity','0');return;}const pRect=partnerNode.getBoundingClientRect();const cRect=contactNode.getBoundingClientRect();line.setAttribute('x1',pRect.right-bounds.left);line.setAttribute('y1',pRect.top-bounds.top+pRect.height/2);line.setAttribute('x2',cRect.left-bounds.left);line.setAttribute('y2',cRect.top-bounds.top+cRect.height/2);line.setAttribute('opacity','1');});};updateLines();board.addEventListener('pointerleave',clear);let resizeObserver=null;const onResize=()=>updateLines();if(typeof ResizeObserver==='function'){resizeObserver=new ResizeObserver(onResize);resizeObserver.observe(board);}else if(typeof window!=='undefined'){window.addEventListener('resize',onResize);}root.__relCleanup=()=>{if(resizeObserver){try{resizeObserver.disconnect();}catch(_err){}resizeObserver=null;}else if(typeof window!=='undefined'){window.removeEventListener('resize',onResize);}nodes.clear();links.clear();segments.length=0;};syncDiagnostics();};
export const renderRelationshipMap=(options={})=>{const{root,contacts,partners,nonePartnerId,openContact,openPartner}=options;if(!root)return;const dataset=buildDataset({contacts,partners,noneId:nonePartnerId||NONE_PARTNER});if(!dataset.edges.length){if(root.__relCleanup)try{root.__relCleanup();}catch(_err){}root.innerHTML='<div class="muted">No partner connections yet.</div>';root.classList.remove('rel-map-root','rel-map-fallback');root.__relCleanup=null;syncDiagnostics();return;}const handlers={openContact:typeof openContact==='function'?(id)=>{const normalized=norm(id);if(normalized)openContact(normalized);}:(id)=>{const normalized=norm(id);if(normalized&&typeof window!=='undefined'&&typeof window.openContactModal==='function')window.openContactModal(normalized);},openPartner:typeof openPartner==='function'?(id)=>{const normalized=norm(id);if(normalized)openPartner(normalized);}:(id)=>{const normalized=norm(id);if(normalized&&typeof window!=='undefined'&&typeof window.openPartnerEditModal==='function')window.openPartnerEditModal(normalized);}};const nodeTotal=dataset.contactNodes.length+dataset.partnerNodes.length;if(nodeTotal>MAX_NODES){renderFallback(root,dataset,handlers);return;}renderMap(root,dataset,handlers);};
