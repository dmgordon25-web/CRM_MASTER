const DAY_MS=86400000,STAGE_ALIASES={application:'application','new application':'application',app:'application',processing:'processing',underwriting:'underwriting',uw:'underwriting',approved:'approved',approval:'approved',ctc:'cleared-to-close','cleared to close':'cleared-to-close','cleared-to-close':'cleared-to-close','clear to close':'cleared-to-close','clear-to-close':'cleared-to-close',funded:'funded',funding:'funded','post close':'post-close','post-close':'post-close',nurture:'post-close',client:'post-close',closed:'funded',lost:'lost',denied:'lost'},STAGE_LABELS={application:'Application',processing:'Processing',underwriting:'Underwriting',approved:'Approved','cleared-to-close':'Clear to Close',funded:'Funded','post-close':'Post-Close',lost:'Lost'},STAGE_GROUP={open:new Set(['application','processing','underwriting']),closing:new Set(['approved','cleared-to-close']),funded:new Set(['funded'])},MONEY=new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}),NUMBER=new Intl.NumberFormat('en-US',{maximumFractionDigits:0}),VIEW=new WeakMap(),ACTIVE=new Set();
const lower=v=>String(v??'').trim().toLowerCase(),normStage=v=>{const k=lower(v);return STAGE_ALIASES[k]||k||'application';},stageCategory=s=>STAGE_GROUP.funded.has(s)?'funded':STAGE_GROUP.closing.has(s)?'closing':STAGE_GROUP.open.has(s)?'open':s==='post-close'?'funded':s==='lost'?'lost':'other',stageLabel=s=>STAGE_LABELS[s]||(s?s.replace(/-/g,' ').replace(/\b\w/g,c=>c.toUpperCase()):'Application'),fmtName=c=>{const f=String(c.first||c.firstName||'').trim(),l=String(c.last||c.lastName||'').trim();return f||l?`${f} ${l}`.trim():String(c.preferredName||c.name||c.company||c.email||c.phone||c.id||'Contact');},parseDate=v=>{if(!v)return null;if(v instanceof Date){const t=v.getTime();return Number.isFinite(t)?t:null;}if(typeof v==='number')return Number.isFinite(v)?(v>1e12?v:v*1000):null;if(typeof v==='string'){const t=v.trim();if(/^[0-9]+$/.test(t)){const n=Number(t);if(Number.isFinite(n))return n>1e12?n:n*1000;}const d=Date.parse(t);return Number.isFinite(d)?d:null;}return null;},fmtDate=t=>Number.isFinite(t)?new Date(t).toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'}):'—',fmtAmount=n=>(n=Number(n||0))>0?MONEY.format(n):'—',fmtCycle=d=>Number.isFinite(d)?d<1?'<1 day':`${NUMBER.format(Math.round(d))} days`:'—',matchesPartner=(c,id)=>id&&[c.partnerId,c.partner,c.buyerPartnerId,c.listingPartnerId,c.referralPartnerId].some(v=>String(v||'')===String(id)),mapContact=c=>{const stage=normStage(c.stage||c.status),updatedTs=parseDate(c.updatedAt||c.stageUpdatedAt||c.modifiedAt||c.lastTouch||c.fundedDate),fundedTs=parseDate(c.fundedDate||c.closedDate||c.closingDate),createdTs=parseDate(c.createdAt||c.created_at||c.stageEnteredAt||c.addedAt||c.firstContactedAt);return{id:String(c.id||c.contactId||''),name:fmtName(c),loanType:c.loanType||c.loanProgram||'Loan',amount:Number(c.loanAmount||c.amount||0)||0,stage,stageLabel:stageLabel(stage),category:stageCategory(stage),updatedTs,updatedLabel:fmtDate(updatedTs),fundedTs,fundedLabel:fundedTs?fmtDate(fundedTs):'',cycleDays:fundedTs&&createdTs?(fundedTs-createdTs)/DAY_MS:null};};
const ensureStructure=state=>{const panel=state.panel;if(!panel)return;let host=panel.querySelector('[data-role="partner-referral-detail"]');if(!host){host=document.createElement('div');host.dataset.role='partner-referral-detail';host.className='partner-referral-detail';panel.insertBefore(host,panel.firstChild);}if(host.__nodes){state.nodes=host.__nodes;return;}host.innerHTML=`<header class="partner-detail-head"><div><h3>Referral Performance</h3><p class="muted">Contacts attributed to this partner</p></div></header><div class="partner-detail-kpis"><div class="partner-kpi-card" data-qa="partner-kpi" data-metric="funded"><span class="partner-kpi-label">Funded Volume</span><span class="partner-kpi-value" data-value>—</span><span class="partner-kpi-foot">Across <span data-count>0</span> funded deals</span></div><div class="partner-kpi-card" data-qa="partner-kpi" data-metric="active"><span class="partner-kpi-label">Active Deals</span><span class="partner-kpi-value" data-value>—</span><span class="partner-kpi-foot">Currently in flight</span></div><div class="partner-kpi-card" data-qa="partner-kpi" data-metric="closed"><span class="partner-kpi-label">Closed Deals</span><span class="partner-kpi-value" data-value>—</span><span class="partner-kpi-foot">Total funded via this partner</span></div><div class="partner-kpi-card" data-qa="partner-kpi" data-metric="cycle"><span class="partner-kpi-label">Avg Time to Fund</span><span class="partner-kpi-value" data-value>—</span><span class="partner-kpi-foot">Application to funding</span></div></div><div class="partner-detail-toolbar"><div class="partner-detail-filters" role="group" aria-label="Filter referrals"><button type="button" class="partner-filter chip" data-filter="all">All</button><button type="button" class="partner-filter chip" data-qa="preset-filter" data-filter="open">Open</button><button type="button" class="partner-filter chip" data-qa="preset-filter" data-filter="closing">Closing Soon</button><button type="button" class="partner-filter chip" data-qa="preset-filter" data-filter="funded">Funded</button></div><div class="partner-detail-count" data-role="partner-detail-count">—</div></div><div class="partner-detail-table"><table><thead><tr><th>Contact</th><th>Status</th><th><button type="button" class="partner-sort" data-sort="amount">Amount</button></th><th><button type="button" class="partner-sort" data-sort="updatedTs">Updated</button></th></tr></thead><tbody data-role="partner-detail-body"></tbody></table></div><div class="partner-detail-empty" data-role="partner-detail-empty">No referred contacts yet.</div>`;const nodes={metrics:{funded:host.querySelector('[data-metric="funded"] [data-value]'),active:host.querySelector('[data-metric="active"] [data-value]'),closed:host.querySelector('[data-metric="closed"] [data-value]'),cycle:host.querySelector('[data-metric="cycle"] [data-value]')},fundedCount:host.querySelector('[data-metric="funded"] [data-count]'),filters:host.querySelector('.partner-detail-filters'),filterButtons:Array.from(host.querySelectorAll('.partner-filter')),count:host.querySelector('[data-role="partner-detail-count"]'),tableBody:host.querySelector('[data-role="partner-detail-body"]'),empty:host.querySelector('[data-role="partner-detail-empty"]'),sortButtons:Array.from(host.querySelectorAll('.partner-sort'))};nodes.filters.addEventListener('click',evt=>{const btn=evt.target&&evt.target.closest('[data-filter]');if(!btn)return;const key=btn.getAttribute('data-filter');state.filter=state.filter===key?'all':key;applyState(state);});nodes.tableBody.addEventListener('click',evt=>{const row=evt.target&&evt.target.closest('tr[data-contact-id]');if(!row)return;const id=row.getAttribute('data-contact-id');if(id&&typeof window.renderContactModal==='function')window.renderContactModal(id,{sourceHint:'partner:detail'});});nodes.sortButtons.forEach(btn=>btn.addEventListener('click',evt=>{evt.preventDefault();const field=btn.getAttribute('data-sort');if(!field)return;if(state.sort.field===field)state.sort.direction=state.sort.direction==='asc'?'desc':'asc';else{state.sort.field=field;state.sort.direction='desc';}applyState(state);}));host.__nodes=nodes;state.nodes=nodes;};
const hideLegacy=state=>{const wrap=state.panel&&state.panel.querySelector('#partner-linked');if(wrap){wrap.style.display='none';wrap.setAttribute('hidden','true');wrap.setAttribute('aria-hidden','true');}},updateMetrics=state=>{const data=state.data||[],funded=data.filter(i=>i.category==='funded'),active=data.filter(i=>i.category==='open'||i.category==='closing'),volume=funded.reduce((sum,i)=>sum+i.amount,0),cycles=funded.map(i=>i.cycleDays).filter(Number.isFinite),avg=cycles.length?cycles.reduce((a,b)=>a+b,0)/cycles.length:null,{metrics,fundedCount}=state.nodes;metrics.funded.textContent=volume>0?MONEY.format(volume):'—';metrics.active.textContent=NUMBER.format(active.length);metrics.closed.textContent=NUMBER.format(funded.length);metrics.cycle.textContent=fmtCycle(avg);if(fundedCount)fundedCount.textContent=NUMBER.format(funded.length);},escapeHtml=value=>String(value==null?'':value).replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]||ch)),renderRows=state=>{const {tableBody,empty}=state.nodes;tableBody.innerHTML='';if(!state.visible.length){empty.style.display='block';return;}empty.style.display='none';state.visible.forEach(item=>{const tr=document.createElement('tr');tr.dataset.contactId=item.id;tr.dataset.qa='partner-ref-row';const sub=item.fundedLabel?`Funded ${item.fundedLabel}`:item.loanType;tr.innerHTML=`<td><div class="partner-ref-name">${escapeHtml(item.name)}</div><div class="partner-ref-sub muted">${escapeHtml(sub)}</div></td><td><span class="linked-stage" data-stage="${escapeHtml(item.stage)}">${escapeHtml(item.stageLabel)}</span></td><td class="partner-ref-amount">${fmtAmount(item.amount)}</td><td class="partner-ref-updated">${escapeHtml(item.updatedLabel)}</td>`;tableBody.appendChild(tr);});},updateSummary=state=>{const total=(state.data||[]).length;if(state.summary)state.summary.textContent=total?`${total} referred contact${total===1?'':'s'} in pipeline.`:'No referred contacts yet.';if(state.summaryMetric){if(total){state.summaryMetric.textContent=String(total);state.summaryMetric.dataset.count=String(total);}else{state.summaryMetric.textContent='—';state.summaryMetric.dataset.count='0';}}if(state.nodes&&state.nodes.count)state.nodes.count.textContent=total?`${NUMBER.format(total)} contacts`:'No contacts';},applyState=state=>{if(!state.nodes)return;updateMetrics(state);const filterKey=state.filter||'all';state.nodes.filterButtons.forEach(btn=>{const key=btn.getAttribute('data-filter'),active=key===filterKey||(filterKey==='all'&&key==='all');btn.classList.toggle('active',active);btn.setAttribute('aria-pressed',active?'true':'false');});const data=state.data||[],filtered=filterKey==='all'?data:data.filter(item=>item.category===filterKey),dir=state.sort.direction==='asc'?1:-1,field=state.sort.field;state.visible=filtered.slice().sort((a,b)=>field==='amount'?(a.amount-b.amount)*dir:field==='updatedTs'?((a.updatedTs||0)-(b.updatedTs||0))*dir:a.name.localeCompare(b.name)*dir);state.nodes.sortButtons.forEach(btn=>{const key=btn.getAttribute('data-sort'),active=key===field;btn.dataset.active=active?'1':'0';btn.dataset.direction=active?state.sort.direction:'';});renderRows(state);updateSummary(state);logDiagnostics();};
const refreshState=async state=>{if(!state.dialog||!document.body.contains(state.dialog)){ACTIVE.delete(state);return;}ensureStructure(state);hideLegacy(state);const id=state.partnerId;if(!id){state.data=[];applyState(state);return;}const token=Date.now();state.loadToken=token;try{await openDB();const contacts=await dbGetAll('contacts');state.data=(contacts||[]).filter(c=>matchesPartner(c,id)).map(mapContact);}catch(err){state.data=[];console&&console.warn&&console.warn('[partners_detail] load failed',err);}if(state.loadToken===token)applyState(state);};
const getState=dialog=>{let state=VIEW.get(dialog);if(!state){state={dialog,panel:dialog.querySelector('.partner-panel[data-panel="linked"]'),summary:dialog.querySelector('#partner-linked-summary'),summaryMetric:dialog.querySelector('#p-summary-linked'),partnerId:String(dialog.dataset?.partnerId||''),filter:'all',sort:{field:'updatedTs',direction:'desc'},data:[],visible:[]};VIEW.set(dialog,state);}else{state.panel=dialog.querySelector('.partner-panel[data-panel="linked"]');state.summary=dialog.querySelector('#partner-linked-summary');state.summaryMetric=dialog.querySelector('#p-summary-linked');}return state;},onPartnerReady=event=>{const detail=event&&event.detail?event.detail:{},dialog=detail.dialog;if(!dialog)return;const state=getState(dialog);state.partnerId=String(detail.record&&detail.record.id?detail.record.id:dialog.dataset?.partnerId||'');ensureStructure(state);hideLegacy(state);ACTIVE.add(state);refreshState(state);},onDataChanged=()=>ACTIVE.forEach(refreshState),logDiagnostics=()=>{if(!console||typeof console.log!=='function')return;console.log('REFERRAL_SUMMARY',{kpis:document.querySelectorAll('[data-qa="partner-kpi"]').length,rows:document.querySelectorAll('[data-qa="partner-ref-row"]').length,filters:document.querySelectorAll('[data-qa="preset-filter"]').length});};
if(typeof document!=='undefined'){document.addEventListener('partner:modal:ready',onPartnerReady,{passive:true});document.addEventListener('app:data:changed',onDataChanged,{passive:true});}
export default {};
